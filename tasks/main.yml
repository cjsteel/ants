---
# tasks file for ansible-role-acemenu

# see following
#
# http://stackoverflow.com/questions/33343215/how-to-get-remote-users-home-directory-in-ansible
# http://stackoverflow.com/questions/21344777/how-to-switch-a-user-per-task-or-set-of-tasks

# iterate to gather all of a systems regular users and save to list?


# discover home directories including those mounted by LDAP

- name:
  shell: >
    getent passwd {{ item }} | cut -d: -f6
  changed_when: false
  register: user_homes
  with_items: acemenu_users

- debug: msg="item.item={{item.item}}, item.stdout={{item.stdout}}, item.changed={{item.changed}}"
  with_items: "{{user_homes.results}}"

- name: debug output
  debug: var=user_homes.stdout

- name: ensure for remote directories
  become: '{{ item.stdout | basename }}'
  file:
    state   : 'directory'
    path    : '{{ item.stdout }}/{{ acemenu_bin_dir }}'
    owner   : '{{ item.stdout | basename }}'
    group   : '{{ item.stdout | basename }}'
    mode    : '0740'
  with_items: "{{ user_homes.results }}"

- name: "template our menu script"
  become: '{{ item.stdout | basename }}'
  template:
    backup  : yes
    src     : '{{ ansible_distribution }}/{{ ansible_distribution_version }}/acemenu/menu.j2'
    dest    : '{{ item.stdout }}/{{ acemenu_bin_dir }}/menu'
    owner   : '{{ item.stdout | basename }}'
    group   : '{{ item.stdout | basename }}'
    mode    : '0740'
  with_items: "{{ user_homes.results }}"

- name: "template our menu items"
  become: '{{ item.stdout | basename }}'
  template:
    backup  : yes
    src     : '{{ ansible_distribution }}/{{ ansible_distribution_version }}/acemenu/menuitems.j2'
    dest    : '{{ item.stdout }}/{{ acemenu_bin_dir }}/menuitems.txt'
    owner   : '{{ item.stdout | basename }}'
    group   : '{{ item.stdout | basename }}'
    mode    : '0640'
  with_items: "{{ user_homes.results }}"

- name: "ensure for our path block in ~/.bashrc"
  become: '{{ item.stdout | basename }}'
  blockinfile:
    dest: '{{ item.stdout }}/.bashrc'
    marker: '# {mark} ANSIBLE MANAGED BLOCK'
    insertafter: EOF
    block: |
      # set PATH to include '{{ item.stdout }}/{{ acemenu_bin_dir }}'
      if [ -d {{ item.stdout }}/{{ acemenu_bin_dir }} ] ; then
         PATH={{ item.stdout }}/{{ acemenu_bin_dir }}:${PATH} 
      fi
  with_items: "{{ user_homes.results }}"

